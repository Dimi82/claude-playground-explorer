<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Architecture Explorer</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0d1117; color: #c9d1d9; min-height: 100vh; display: flex; flex-direction: column;
    }
    header {
      background: #161b22; border-bottom: 1px solid #30363d; padding: 16px 24px;
      display: flex; align-items: center; justify-content: space-between;
    }
    header h1 { font-size: 20px; font-weight: 600; color: #f0f6fc; }
    .header-actions { display: flex; gap: 8px; }
    .header-btn {
      background: #21262d; border: 1px solid #30363d; border-radius: 6px;
      padding: 6px 12px; color: #c9d1d9; font-size: 12px; cursor: pointer;
    }
    .header-btn:hover { background: #30363d; }
    .header-btn.active { background: #238636; border-color: #238636; color: white; }
    .main-container { display: flex; flex: 1; overflow: hidden; }

    /* Left Panel */
    .component-tree {
      width: 280px; background: #161b22; border-right: 1px solid #30363d;
      overflow-y: auto; padding: 16px 0;
    }
    .tree-section { margin-bottom: 8px; }
    .tree-section-header {
      padding: 8px 16px; font-size: 11px; font-weight: 600;
      text-transform: uppercase; color: #8b949e; letter-spacing: 0.5px;
    }
    .tree-item {
      padding: 8px 16px 8px 24px; cursor: pointer; display: flex;
      align-items: center; gap: 8px; transition: background 0.15s; font-size: 13px;
      position: relative;
    }
    .tree-item:hover { background: #21262d; }
    .tree-item.active { background: #388bfd26; color: #58a6ff; border-left: 2px solid #58a6ff; padding-left: 22px; }
    .tree-item.has-annotation::after {
      content: ''; position: absolute; right: 12px; top: 50%; transform: translateY(-50%);
      width: 8px; height: 8px; border-radius: 50%; background: #f0883e;
    }
    .tree-item .icon {
      width: 16px; height: 16px; border-radius: 3px; display: flex;
      align-items: center; justify-content: center; font-size: 10px; font-weight: bold;
    }
    .icon-node { background: #238636; color: white; }
    .icon-llm { background: #a371f7; color: white; }
    .icon-tool { background: #f0883e; color: white; }
    .icon-state { background: #3fb950; color: white; }
    .icon-entry { background: #58a6ff; color: white; }

    /* Center Panel */
    .diagram-panel { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
    .diagram-header {
      background: #161b22; border-bottom: 1px solid #30363d; padding: 12px 24px;
      display: flex; align-items: center; justify-content: space-between;
    }
    .view-tabs { display: flex; gap: 4px; }
    .view-tab {
      padding: 6px 12px; background: transparent; border: 1px solid #30363d;
      border-radius: 6px; color: #8b949e; cursor: pointer; font-size: 12px;
    }
    .view-tab:hover { background: #21262d; color: #c9d1d9; }
    .view-tab.active { background: #21262d; color: #f0f6fc; border-color: #58a6ff; }
    .diagram-canvas { flex: 1; position: relative; overflow: auto; padding: 40px; }

    /* Workflow Diagram */
    .workflow-diagram { display: flex; flex-direction: column; align-items: flex-end; gap: 20px; min-width: 800px; padding-right: 80px; }
    .phase-row { display: flex; align-items: center; gap: 24px; }
    .workflow-below-phase3 { display: flex; flex-direction: column; align-items: center; gap: 20px; }
    .node-box {
      background: #21262d; border: 2px solid #30363d; border-radius: 8px;
      padding: 16px 20px; min-width: 180px; cursor: pointer; transition: all 0.2s;
      text-align: center; position: relative;
    }
    .node-box:hover { border-color: #58a6ff; transform: translateY(-2px); }
    .node-box.selected { border-color: #58a6ff; background: #388bfd26; }
    .node-box.has-annotation { box-shadow: 0 0 0 3px #f0883e40; }
    .node-box.phase-1 { border-left: 4px solid #58a6ff; }
    .node-box.phase-2 { border-left: 4px solid #a371f7; }
    .node-box.phase-3 { border-left: 4px solid #3fb950; }
    .node-box.phase-4 { border-left: 4px solid #f0883e; }
    .node-title { font-weight: 600; font-size: 14px; margin-bottom: 4px; }
    .node-subtitle { font-size: 11px; color: #8b949e; }
    .annotation-badge {
      position: absolute; top: -8px; right: -8px; width: 20px; height: 20px;
      background: #f0883e; border-radius: 50%; display: flex; align-items: center;
      justify-content: center; font-size: 10px; font-weight: bold; color: white;
    }
    .arrow { color: #484f58; font-size: 24px; cursor: pointer; padding: 4px; border-radius: 4px; }
    .arrow:hover { background: #21262d; }
    .arrow.has-annotation { color: #f0883e; }
    .arrow-down { margin: 8px 0; }
    .conditional-box {
      background: #161b22; border: 2px dashed #30363d; border-radius: 8px;
      padding: 12px 16px; font-size: 12px; color: #8b949e; cursor: pointer;
    }
    .conditional-box:hover { border-color: #58a6ff; }
    .conditional-box.has-annotation { border-color: #f0883e; }
    .branch-container { display: flex; gap: 60px; align-items: flex-start; }
    .branch { display: flex; flex-direction: column; align-items: center; gap: 16px; }
    .branch-label { font-size: 11px; color: #8b949e; padding: 4px 8px; background: #21262d; border-radius: 4px; }

    /* Data Flow */
    .data-flow-diagram { display: flex; flex-direction: column; gap: 32px; padding: 20px; }
    .flow-layer { display: flex; align-items: center; gap: 24px; }
    .flow-layer-label { width: 120px; font-size: 11px; font-weight: 600; text-transform: uppercase; color: #8b949e; text-align: right; }
    .flow-boxes { display: flex; gap: 16px; flex-wrap: wrap; }
    .flow-box {
      background: #21262d; border: 1px solid #30363d; border-radius: 6px;
      padding: 12px 16px; font-size: 12px; cursor: pointer; position: relative;
    }
    .flow-box:hover { border-color: #58a6ff; }
    .flow-box.selected { border-color: #58a6ff; background: #388bfd26; }
    .flow-box.has-annotation { box-shadow: 0 0 0 2px #f0883e40; }

    /* File Tree */
    .file-tree { font-family: 'SF Mono', Monaco, monospace; font-size: 13px; padding: 20px; }
    .file-entry { padding: 4px 0; cursor: pointer; display: flex; align-items: center; gap: 8px; position: relative; }
    .file-entry:hover { color: #58a6ff; }
    .file-entry.selected { color: #58a6ff; }
    .file-entry.has-annotation::after {
      content: ''; position: absolute; right: 0; width: 8px; height: 8px;
      border-radius: 50%; background: #f0883e;
    }
    .file-indent { color: #484f58; }
    .file-icon { width: 16px; text-align: center; }

    /* Sequence Diagram */
    .sequence-diagram { padding: 40px; display: flex; flex-direction: column; gap: 60px; }
    .sequence-flow { display: flex; flex-direction: column; min-width: 800px; }
    .sequence-flow-title { font-size: 14px; font-weight: 600; color: #f0f6fc; margin-bottom: 20px; padding-bottom: 12px; border-bottom: 1px solid #30363d; }
    .participant-header { display: grid; gap: 40px; margin-bottom: 0; position: relative; z-index: 2; }
    .participant-box {
      background: #21262d; border: 2px solid #30363d; border-radius: 8px;
      padding: 12px 16px; text-align: center; font-weight: 600; font-size: 13px;
      position: relative;
    }
    .participant-box::after {
      content: ''; position: absolute; bottom: -20px; left: 50%;
      transform: translateX(-50%); width: 2px; height: 20px; background: #30363d;
    }
    .sequence-timeline { display: grid; gap: 40px; position: relative; min-height: 100px; }
    .lifeline-column { display: flex; flex-direction: column; align-items: center; position: relative; }
    .lifeline { width: 2px; background: #30363d; position: absolute; top: 0; bottom: 0; left: 50%; transform: translateX(-50%); }
    .messages-layer { position: absolute; top: 20px; left: 0; right: 0; display: flex; flex-direction: column; gap: 24px; z-index: 1; }
    .message-row { display: grid; gap: 40px; align-items: center; min-height: 40px; }
    .message-arrow {
      position: relative; display: flex; align-items: center; justify-content: center;
      cursor: pointer; padding: 4px 0; transition: all 0.2s; min-height: 32px;
    }
    .message-arrow::before {
      content: ''; position: absolute; height: 2px; background: #58a6ff;
      left: 20px; right: 20px; top: 50%;
    }
    .message-arrow::after {
      content: ''; position: absolute; right: 12px; top: 50%; transform: translateY(-50%);
      border: 6px solid transparent; border-left: 8px solid #58a6ff;
    }
    .message-arrow.reverse::after {
      right: auto; left: 12px;
      border-left: none; border-right: 8px solid #58a6ff;
    }
    .message-arrow.return::before { background: #8b949e; height: 0; border-top: 2px dashed #8b949e; }
    .message-arrow.return::after { border-left-color: #8b949e; }
    .message-arrow.return.reverse::after { border-right-color: #8b949e; border-left-color: transparent; }
    .message-arrow.async::before { background: #a371f7; }
    .message-arrow.async::after { border-left-color: #a371f7; }
    .message-arrow.async.reverse::after { border-right-color: #a371f7; border-left-color: transparent; }
    .message-arrow.self-call {
      justify-content: flex-end; padding-right: 20px; min-height: 50px;
    }
    .message-arrow.self-call::before {
      left: 50%; right: -30px; top: 0; height: 100%;
      background: none; border: 2px solid #58a6ff; border-left: none;
      border-radius: 0 8px 8px 0;
    }
    .message-arrow.self-call::after {
      right: auto; left: calc(50% - 8px); top: auto; bottom: -2px;
      transform: rotate(90deg);
    }
    .message-label {
      background: #0d1117; padding: 4px 12px; border-radius: 4px;
      font-size: 12px; color: #c9d1d9; z-index: 1; position: relative;
      white-space: nowrap; border: 1px solid #30363d; max-width: 200px;
      overflow: hidden; text-overflow: ellipsis;
    }
    .message-arrow:hover { transform: translateY(-2px); }
    .message-arrow:hover .message-label { background: #161b22; border-color: #58a6ff; }
    .message-arrow.selected::before { background: #58a6ff; box-shadow: 0 0 8px #58a6ff80; }
    .message-arrow.selected .message-label { background: #388bfd26; border-color: #58a6ff; color: #58a6ff; }
    .message-arrow.has-annotation .message-label::after {
      content: ''; position: absolute; right: -6px; top: -6px;
      width: 12px; height: 12px; background: #f0883e; border-radius: 50%; border: 2px solid #0d1117;
    }
    .sequence-fragment {
      border: 2px dashed #30363d; border-radius: 8px; padding: 16px;
      margin: 8px 0; background: #161b2210; position: relative;
    }
    .fragment-label {
      position: absolute; top: -10px; left: 12px; background: #0d1117;
      padding: 2px 8px; font-size: 10px; font-weight: 600;
      text-transform: uppercase; color: #8b949e; border: 1px solid #30363d; border-radius: 4px;
    }
    .sequence-fragment.loop { border-color: #3fb950; }
    .sequence-fragment.loop .fragment-label { color: #3fb950; border-color: #3fb950; }
    .sequence-fragment.alt { border-color: #f0883e; }
    .sequence-fragment.alt .fragment-label { color: #f0883e; border-color: #f0883e; }
    .sequence-fragment.opt { border-color: #a371f7; }
    .sequence-fragment.opt .fragment-label { color: #a371f7; border-color: #a371f7; }

    /* Right Panel */
    .details-panel { width: 420px; background: #161b22; border-left: 1px solid #30363d; display: flex; flex-direction: column; }
    .details-header { padding: 16px 20px; border-bottom: 1px solid #30363d; display: flex; align-items: center; justify-content: space-between; }
    .details-title { font-weight: 600; font-size: 16px; }
    .details-badge { font-size: 10px; padding: 3px 8px; border-radius: 12px; font-weight: 600; text-transform: uppercase; }
    .badge-node { background: #238636; color: white; }
    .badge-llm { background: #a371f7; color: white; }
    .badge-tool { background: #f0883e; color: white; }
    .badge-state { background: #3fb950; color: white; }
    .badge-entry { background: #58a6ff; color: white; }
    .details-content { flex: 1; overflow-y: auto; padding: 20px; }
    .detail-section { margin-bottom: 24px; }
    .detail-section-title { font-size: 11px; font-weight: 600; text-transform: uppercase; color: #8b949e; margin-bottom: 12px; letter-spacing: 0.5px; }
    .detail-text { font-size: 13px; line-height: 1.6; color: #c9d1d9; }
    .detail-code { background: #0d1117; border: 1px solid #30363d; border-radius: 6px; padding: 12px; font-family: 'SF Mono', Monaco, monospace; font-size: 12px; overflow-x: auto; white-space: pre; }
    .detail-list { list-style: none; }
    .detail-list li { padding: 6px 0; font-size: 13px; display: flex; align-items: flex-start; gap: 8px; }
    .detail-list li::before { content: '\2022'; color: #58a6ff; }
    .detail-file { font-family: 'SF Mono', Monaco, monospace; font-size: 12px; color: #58a6ff; padding: 8px 12px; background: #0d1117; border-radius: 4px; margin-bottom: 8px; display: inline-block; }

    /* Annotations Section */
    .annotations-section { background: #0d1117; border-radius: 8px; padding: 16px; margin-bottom: 16px; }
    .annotation-item { background: #161b22; border: 1px solid #30363d; border-radius: 6px; padding: 12px; margin-bottom: 8px; }
    .annotation-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
    .annotation-type { font-size: 10px; padding: 2px 8px; border-radius: 10px; font-weight: 600; text-transform: uppercase; }
    .annotation-type.question { background: #388bfd40; color: #58a6ff; }
    .annotation-type.comment { background: #3fb95040; color: #3fb950; }
    .annotation-type.edit { background: #f0883e40; color: #f0883e; }
    .annotation-delete { background: none; border: none; color: #f85149; cursor: pointer; font-size: 14px; }
    .annotation-text { font-size: 13px; line-height: 1.5; margin-bottom: 8px; }
    .annotation-prompt {
      background: #0d1117; border: 1px solid #30363d; border-radius: 4px;
      padding: 10px; font-family: 'SF Mono', Monaco, monospace; font-size: 11px;
      line-height: 1.4; color: #8b949e; white-space: pre-wrap; margin-top: 8px;
    }
    .annotation-prompt-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px; }
    .annotation-prompt-label { font-size: 10px; color: #6e7681; text-transform: uppercase; }
    .annotation-copy-btn {
      background: #21262d; border: 1px solid #30363d; border-radius: 4px;
      padding: 3px 8px; font-size: 10px; color: #8b949e; cursor: pointer;
    }
    .annotation-copy-btn:hover { background: #30363d; color: #c9d1d9; }
    .annotation-copy-btn.copied { background: #238636; border-color: #238636; color: white; }
    .add-annotation-btn {
      width: 100%; padding: 10px; background: #21262d; border: 1px dashed #30363d;
      border-radius: 6px; color: #8b949e; font-size: 12px; cursor: pointer; margin-top: 8px;
    }
    .add-annotation-btn:hover { background: #30363d; color: #c9d1d9; border-style: solid; }

    /* Question Panel */
    .question-panel { border-top: 1px solid #30363d; padding: 16px 20px; background: #0d1117; }
    .question-input-container { display: flex; gap: 8px; }
    .question-input { flex: 1; background: #161b22; border: 1px solid #30363d; border-radius: 6px; padding: 10px 14px; color: #c9d1d9; font-size: 13px; outline: none; }
    .question-input:focus { border-color: #58a6ff; }
    .question-input::placeholder { color: #484f58; }
    .question-btn { background: #238636; border: none; border-radius: 6px; padding: 10px 16px; color: white; font-size: 13px; font-weight: 500; cursor: pointer; }
    .question-btn:hover { background: #2ea043; }

    /* Context Menu */
    .context-menu {
      position: fixed; background: #161b22; border: 1px solid #30363d; border-radius: 8px;
      padding: 8px 0; min-width: 180px; z-index: 1000; box-shadow: 0 8px 24px rgba(0,0,0,0.4);
      display: none;
    }
    .context-menu.visible { display: block; }
    .context-menu-item { padding: 8px 16px; font-size: 13px; cursor: pointer; display: flex; align-items: center; gap: 10px; }
    .context-menu-item:hover { background: #21262d; }
    .context-menu-item .icon { font-size: 14px; }
    .context-menu-divider { height: 1px; background: #30363d; margin: 4px 0; }

    /* Annotation Modal */
    .modal-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.6); z-index: 1001; display: none;
      align-items: center; justify-content: center;
    }
    .modal-overlay.visible { display: flex; }
    .modal {
      background: #161b22; border: 1px solid #30363d; border-radius: 12px;
      padding: 24px; width: 400px; max-width: 90%;
    }
    .modal-title { font-size: 18px; font-weight: 600; margin-bottom: 16px; }
    .modal-field { margin-bottom: 16px; }
    .modal-label { font-size: 12px; color: #8b949e; margin-bottom: 6px; display: block; }
    .modal-select, .modal-textarea {
      width: 100%; background: #0d1117; border: 1px solid #30363d; border-radius: 6px;
      padding: 10px 12px; color: #c9d1d9; font-size: 13px;
    }
    .modal-textarea { min-height: 100px; resize: vertical; font-family: inherit; }
    .modal-actions { display: flex; gap: 8px; justify-content: flex-end; }
    .modal-btn { padding: 8px 16px; border-radius: 6px; font-size: 13px; cursor: pointer; border: none; }
    .modal-btn.primary { background: #238636; color: white; }
    .modal-btn.secondary { background: #21262d; color: #c9d1d9; border: 1px solid #30363d; }
    .modal-btn:hover { opacity: 0.9; }

    /* Annotations Summary Panel */
    .annotations-summary { background: #161b22; border-bottom: 1px solid #30363d; padding: 12px 20px; display: none; }
    .annotations-summary.visible { display: block; }
    .annotations-summary-title { font-size: 11px; font-weight: 600; text-transform: uppercase; color: #8b949e; margin-bottom: 8px; }
    .annotations-stats { display: flex; gap: 16px; }
    .stat-item { display: flex; align-items: center; gap: 6px; font-size: 12px; }
    .stat-dot { width: 8px; height: 8px; border-radius: 50%; }
    .stat-dot.question { background: #58a6ff; }
    .stat-dot.comment { background: #3fb950; }
    .stat-dot.edit { background: #f0883e; }

    /* ========== Enhanced Workflow Diagram (V2) ========== */
    .workflow-diagram-v2 {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 60px;
      padding: 60px 40px;
      min-width: 900px;
      position: relative;
    }

    .workflow-layer {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      gap: 80px;
      width: 100%;
      position: relative;
      z-index: 2;
      min-height: 80px;
    }

    .workflow-node {
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }

    .workflow-node:hover { transform: translateY(-2px); }
    .workflow-node.selected { box-shadow: 0 0 0 3px #58a6ff; }
    .workflow-node.has-annotation::after {
      content: attr(data-annotation-count);
      position: absolute;
      top: -8px;
      right: -8px;
      width: 20px;
      height: 20px;
      background: #f0883e;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: bold;
      color: white;
    }

    .workflow-node-start,
    .workflow-node-end {
      width: 140px;
      height: 70px;
      border-radius: 35px;
      background: #21262d;
      border: 3px solid #30363d;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 14px;
      color: #c9d1d9;
    }

    .workflow-node-start { border-color: #3fb950; background: #3fb95015; }
    .workflow-node-end { border-color: #f85149; background: #f8514915; }

    .workflow-node-process {
      min-width: 180px;
      max-width: 220px;
      background: #21262d;
      border: 2px solid #30363d;
      border-radius: 8px;
      padding: 16px 20px;
    }

    .workflow-node-process.phase-1 { border-left: 4px solid #58a6ff; }
    .workflow-node-process.phase-2 { border-left: 4px solid #a371f7; }
    .workflow-node-process.phase-3 { border-left: 4px solid #3fb950; }
    .workflow-node-process.phase-4 { border-left: 4px solid #f0883e; }

    .workflow-node-title {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 4px;
      color: #f0f6fc;
    }

    .workflow-node-subtitle {
      font-size: 11px;
      color: #8b949e;
    }

    .workflow-node-decision {
      width: 120px;
      height: 120px;
      background: #161b22;
      border: 3px solid #f0883e;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      transform: rotate(45deg);
    }

    .workflow-node-decision .decision-content {
      transform: rotate(-45deg);
      text-align: center;
      padding: 10px;
      font-size: 12px;
      font-weight: 600;
      color: #f0883e;
      max-width: 80px;
      line-height: 1.3;
    }

    .workflow-node-merge {
      width: 40px;
      height: 40px;
      background: #21262d;
      border: 3px solid #8b949e;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #8b949e;
      font-size: 16px;
    }

    .workflow-edges {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
      pointer-events: none;
      overflow: visible;
    }

    .workflow-edge {
      stroke: #58a6ff;
      stroke-width: 2;
      fill: none;
      transition: stroke 0.2s;
    }

    .workflow-edge.loop {
      stroke: #a371f7;
      stroke-dasharray: 6, 4;
    }

    .workflow-edge.secondary {
      stroke: #8b949e;
    }

    .workflow-edge-label {
      font-size: 11px;
      fill: #8b949e;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <header>
    <h1 id="header-title">Architecture Explorer</h1>
    <div class="header-actions">
      <button class="header-btn" id="export-btn">Export Annotations</button>
      <button class="header-btn" id="reset-btn">Reset All</button>
      <button class="header-btn" id="clear-btn">Clear Annotations</button>
    </div>
  </header>

  <div class="annotations-summary" id="annotations-summary">
    <div class="annotations-summary-title">Annotations</div>
    <div class="annotations-stats" id="annotations-stats"></div>
  </div>

  <div class="main-container">
    <div class="component-tree" id="component-tree"></div>
    <div class="diagram-panel">
      <div class="diagram-header">
        <div class="view-tabs">
          <button class="view-tab active" data-view="workflow">Workflow</button>
          <button class="view-tab" data-view="dataflow">Data Flow</button>
          <button class="view-tab" data-view="sequence">Sequence</button>
          <button class="view-tab" data-view="files">File Structure</button>
        </div>
        <div style="font-size: 11px; color: #8b949e;">Right-click to annotate</div>
      </div>
      <div class="diagram-canvas" id="diagram-canvas"></div>
    </div>
    <div class="details-panel">
      <div class="details-header">
        <span class="details-title" id="detail-title">Select a component</span>
        <span class="details-badge badge-node" id="detail-badge" style="display: none;">NODE</span>
      </div>
      <div class="details-content" id="detail-content"></div>
      <div class="question-panel">
        <div class="question-input-container">
          <input type="text" class="question-input" id="question-input" placeholder="Ask about the architecture...">
          <button class="question-btn" id="ask-btn">Ask</button>
        </div>
      </div>
    </div>
  </div>

  <div class="context-menu" id="context-menu">
    <div class="context-menu-item" data-action="question"><span class="icon">?</span> Add Question</div>
    <div class="context-menu-item" data-action="comment"><span class="icon">C</span> Add Comment</div>
    <div class="context-menu-item" data-action="edit"><span class="icon">E</span> Mark for Edit</div>
    <div class="context-menu-divider"></div>
    <div class="context-menu-item" data-action="view"><span class="icon">V</span> View Details</div>
  </div>

  <div class="modal-overlay" id="modal-overlay">
    <div class="modal">
      <div class="modal-title" id="modal-title">Add Annotation</div>
      <div class="modal-field">
        <label class="modal-label">Type</label>
        <select class="modal-select" id="annotation-type">
          <option value="question">Question</option>
          <option value="comment">Comment</option>
          <option value="edit">Edit Suggestion</option>
        </select>
      </div>
      <div class="modal-field">
        <label class="modal-label">Your annotation</label>
        <textarea class="modal-textarea" id="annotation-text" placeholder="Enter your question, comment, or edit suggestion..."></textarea>
      </div>
      <div class="modal-actions">
        <button class="modal-btn secondary" id="modal-cancel">Cancel</button>
        <button class="modal-btn primary" id="modal-save">Save</button>
      </div>
    </div>
  </div>

  <!-- External config: include before main script -->
  <!-- Example: <script src="config-myproject.js"></script> -->
  <!-- The config.js file should define: window.EXTERNAL_CONFIG = { projectName: "...", ... }; -->

  <script>
    // ============ CONFIGURATION LOADER ============
    (function init() {
      // Load config: prefer external window.EXTERNAL_CONFIG, fall back to inline
      function loadConfig() {
        // Check for externally loaded config (via <script src="config.js">)
        if (window.EXTERNAL_CONFIG) {
          return window.EXTERNAL_CONFIG;
        }

        // No external config and no inline config - show error
        alert('No configuration found. Either:\n1. Include a config script: <script src="config-name.js">\n2. Replace {{CONFIG_JSON}} with inline config');
        throw new Error('No configuration found');
      }

      const CONFIG = loadConfig();
    // ============ END CONFIGURATION LOADER ============

    const PROJECT_NAME = CONFIG.projectName;
    const INITIAL_COMPONENT_DATA = CONFIG.componentData;
    const INITIAL_TREE_STRUCTURE = CONFIG.treeStructure;
    const DATA_FLOW_LAYERS = CONFIG.dataFlowLayers;
    const FILE_TREE_ENTRIES = CONFIG.fileTreeEntries;
    const WORKFLOW_STRUCTURE = CONFIG.workflowStructure || [];
    const SEQUENCE_FLOWS = CONFIG.sequenceFlows || [];

    const STORAGE_KEY = 'architecture-explorer-' + PROJECT_NAME.toLowerCase().replace(/\s+/g, '-');

    const state = {
      componentData: { ...INITIAL_COMPONENT_DATA },
      treeStructure: JSON.parse(JSON.stringify(INITIAL_TREE_STRUCTURE)),
      selectedComponent: null,
      currentView: 'workflow',
      annotations: {},
      contextTarget: null
    };

    function saveState() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify({ annotations: state.annotations, version: 1 }));
      } catch (e) { console.warn('Failed to save:', e); }
    }

    function loadState() {
      try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
          const p = JSON.parse(saved);
          if (p.version === 1) { state.annotations = p.annotations || {}; return true; }
        }
      } catch (e) { console.warn('Failed to load:', e); }
      return false;
    }

    function clearState() {
      if (confirm('Reset explorer to default state? This will clear all your annotations.')) {
        localStorage.removeItem(STORAGE_KEY);
        location.reload();
      }
    }

    function updateAnnotationsSummary() {
      var summary = document.getElementById('annotations-summary');
      var stats = document.getElementById('annotations-stats');
      var counts = { question: 0, comment: 0, edit: 0 };
      Object.values(state.annotations).forEach(function(list) {
        list.forEach(function(a) { counts[a.type]++; });
      });
      var total = counts.question + counts.comment + counts.edit;
      if (total > 0) {
        summary.classList.add('visible');
        stats.textContent = '';
        ['question', 'comment', 'edit'].forEach(function(type) {
          if (counts[type] > 0) {
            var item = document.createElement('div');
            item.className = 'stat-item';
            var dot = document.createElement('span');
            dot.className = 'stat-dot ' + type;
            item.appendChild(dot);
            item.appendChild(document.createTextNode(counts[type] + ' ' + type + 's'));
            stats.appendChild(item);
          }
        });
      } else { summary.classList.remove('visible'); }
    }

    function renderTree() {
      var tree = document.getElementById('component-tree');
      tree.textContent = '';
      state.treeStructure.forEach(function(section) {
        var sectionDiv = document.createElement('div');
        sectionDiv.className = 'tree-section';
        var header = document.createElement('div');
        header.className = 'tree-section-header';
        header.textContent = section.header;
        sectionDiv.appendChild(header);
        section.items.forEach(function(item) {
          var itemDiv = document.createElement('div');
          itemDiv.className = 'tree-item';
          if (state.selectedComponent === item.id) itemDiv.classList.add('active');
          if (state.annotations[item.id] && state.annotations[item.id].length > 0) itemDiv.classList.add('has-annotation');
          itemDiv.dataset.component = item.id;
          var icon = document.createElement('span');
          icon.className = 'icon ' + item.iconClass;
          icon.textContent = item.icon;
          itemDiv.appendChild(icon);
          var data = state.componentData[item.id];
          itemDiv.appendChild(document.createTextNode(data ? data.title.split(' (')[0] : item.id));
          itemDiv.addEventListener('click', function() { selectComponent(item.id); });
          itemDiv.addEventListener('contextmenu', function(e) { showContextMenu(e, item.id); });
          sectionDiv.appendChild(itemDiv);
        });
        tree.appendChild(sectionDiv);
      });
    }

    function renderWorkflowView() {
      var canvas = document.getElementById('diagram-canvas');
      canvas.textContent = '';
      if (!WORKFLOW_STRUCTURE || WORKFLOW_STRUCTURE.length === 0) {
        var placeholder = document.createElement('div');
        placeholder.style.cssText = 'color: #8b949e; padding: 40px; text-align: center;';
        placeholder.textContent = 'No workflow structure defined';
        canvas.appendChild(placeholder);
        return;
      }
      var diagram = document.createElement('div');
      diagram.className = 'workflow-diagram';
      WORKFLOW_STRUCTURE.forEach(function(row) {
        var rowDiv = document.createElement('div');
        rowDiv.className = 'phase-row';
        row.nodes.forEach(function(nodeId, idx) {
          if (idx > 0) {
            var arrow = document.createElement('span');
            arrow.className = 'arrow';
            arrow.textContent = '\u2192';
            rowDiv.appendChild(arrow);
          }
          rowDiv.appendChild(createNodeBox(nodeId, row.phase || ''));
        });
        diagram.appendChild(rowDiv);
      });
      canvas.appendChild(diagram);
    }

    function renderDataFlowView() {
      var canvas = document.getElementById('diagram-canvas');
      canvas.textContent = '';
      var diagram = document.createElement('div');
      diagram.className = 'data-flow-diagram';
      DATA_FLOW_LAYERS.forEach(function(layer) {
        var layerDiv = document.createElement('div');
        layerDiv.className = 'flow-layer';
        var label = document.createElement('div');
        label.className = 'flow-layer-label';
        label.textContent = layer.label;
        layerDiv.appendChild(label);
        var boxes = document.createElement('div');
        boxes.className = 'flow-boxes';
        layer.items.forEach(function(id) {
          var data = state.componentData[id] || { title: id };
          var box = document.createElement('div');
          box.className = 'flow-box';
          if (state.selectedComponent === id) box.classList.add('selected');
          if (state.annotations[id] && state.annotations[id].length > 0) box.classList.add('has-annotation');
          box.dataset.component = id;
          box.textContent = data.title.split(' (')[0];
          box.addEventListener('click', function() { selectComponent(id); });
          box.addEventListener('contextmenu', function(e) { showContextMenu(e, id); });
          boxes.appendChild(box);
        });
        layerDiv.appendChild(boxes);
        diagram.appendChild(layerDiv);
      });
      canvas.appendChild(diagram);
    }

    function renderFilesView() {
      var canvas = document.getElementById('diagram-canvas');
      canvas.textContent = '';
      var tree = document.createElement('div');
      tree.className = 'file-tree';
      FILE_TREE_ENTRIES.forEach(function(f) {
        var entry = document.createElement('div');
        entry.className = 'file-entry';
        if (f.component && state.selectedComponent === f.component) entry.classList.add('selected');
        if (f.component && state.annotations[f.component] && state.annotations[f.component].length > 0) entry.classList.add('has-annotation');
        if (f.component) entry.dataset.component = f.component;
        if (f.indent) {
          var indent = document.createElement('span');
          indent.className = 'file-indent';
          indent.textContent = f.indent;
          entry.appendChild(indent);
        }
        var icon = document.createElement('span');
        icon.className = 'file-icon';
        icon.textContent = f.icon === 'D' ? 'D' : 'F';
        entry.appendChild(icon);
        entry.appendChild(document.createTextNode(' ' + f.text));
        if (f.component) {
          entry.addEventListener('click', function() { selectComponent(f.component); });
          entry.addEventListener('contextmenu', function(e) { showContextMenu(e, f.component); });
        }
        tree.appendChild(entry);
      });
      canvas.appendChild(tree);
    }

    function renderSequenceView() {
      var canvas = document.getElementById('diagram-canvas');
      canvas.textContent = '';
      if (!SEQUENCE_FLOWS || SEQUENCE_FLOWS.length === 0) {
        var placeholder = document.createElement('div');
        placeholder.style.cssText = 'color: #8b949e; padding: 40px; text-align: center;';
        placeholder.textContent = 'No sequence flows defined';
        canvas.appendChild(placeholder);
        return;
      }
      var diagram = document.createElement('div');
      diagram.className = 'sequence-diagram';
      SEQUENCE_FLOWS.forEach(function(flow) {
        var flowContainer = createSequenceFlow(flow);
        diagram.appendChild(flowContainer);
      });
      canvas.appendChild(diagram);
    }

    function createSequenceFlow(flow) {
      var container = document.createElement('div');
      container.className = 'sequence-flow';
      if (!flow.participants || !Array.isArray(flow.participants) || flow.participants.length === 0) {
        var error = document.createElement('div');
        error.style.cssText = 'color: #f85149; padding: 12px;';
        error.textContent = 'Invalid sequence flow: missing participants';
        container.appendChild(error);
        return container;
      }
      if (flow.name) {
        var title = document.createElement('div');
        title.className = 'sequence-flow-title';
        title.textContent = flow.name;
        container.appendChild(title);
      }
      var header = document.createElement('div');
      header.className = 'participant-header';
      header.style.gridTemplateColumns = 'repeat(' + flow.participants.length + ', 1fr)';
      flow.participants.forEach(function(p) {
        var box = document.createElement('div');
        box.className = 'participant-box';
        var data = state.componentData[p.id];
        box.textContent = data ? data.title.split(' (')[0] : (p.name || p.id || 'Unknown');
        box.dataset.participantId = p.id;
        header.appendChild(box);
      });
      container.appendChild(header);
      var timeline = document.createElement('div');
      timeline.className = 'sequence-timeline';
      timeline.style.gridTemplateColumns = 'repeat(' + flow.participants.length + ', 1fr)';
      var messages = flow.messages || [];
      var timelineHeight = Math.max(100, messages.length * 60 + 40);
      timeline.style.minHeight = timelineHeight + 'px';
      flow.participants.forEach(function(p) {
        var column = document.createElement('div');
        column.className = 'lifeline-column';
        var lifeline = document.createElement('div');
        lifeline.className = 'lifeline';
        column.appendChild(lifeline);
        timeline.appendChild(column);
      });
      var messagesLayer = document.createElement('div');
      messagesLayer.className = 'messages-layer';
      messages.forEach(function(msg) {
        if (!msg.from || !msg.to) return;
        var fromIdx = flow.participants.findIndex(function(p) { return p.id === msg.from; });
        var toIdx = flow.participants.findIndex(function(p) { return p.id === msg.to; });
        if (fromIdx === -1 || toIdx === -1) return;
        var messageRow = document.createElement('div');
        messageRow.className = 'message-row';
        messageRow.style.gridTemplateColumns = 'repeat(' + flow.participants.length + ', 1fr)';
        var arrow = createMessageArrow(msg, fromIdx, toIdx, flow.participants.length);
        messageRow.appendChild(arrow);
        messagesLayer.appendChild(messageRow);
      });
      timeline.appendChild(messagesLayer);
      container.appendChild(timeline);
      return container;
    }

    function createMessageArrow(message, fromIndex, toIndex, participantCount) {
      var arrow = document.createElement('div');
      arrow.className = 'message-arrow';
      if (message.id) arrow.dataset.component = message.id;
      if (message.type === 'return') arrow.classList.add('return');
      if (message.type === 'async') arrow.classList.add('async');
      var isSelfCall = fromIndex === toIndex;
      if (isSelfCall) {
        arrow.classList.add('self-call');
        arrow.style.gridColumn = (fromIndex + 1) + ' / ' + (fromIndex + 2);
      } else {
        var colStart = Math.min(fromIndex, toIndex) + 1;
        var colEnd = Math.max(fromIndex, toIndex) + 2;
        arrow.style.gridColumn = colStart + ' / ' + colEnd;
        if (fromIndex > toIndex) arrow.classList.add('reverse');
      }
      var label = document.createElement('span');
      label.className = 'message-label';
      label.textContent = message.label || '';
      arrow.appendChild(label);
      if (message.id) {
        if (state.selectedComponent === message.id) arrow.classList.add('selected');
        if (state.annotations[message.id] && state.annotations[message.id].length > 0) {
          arrow.classList.add('has-annotation');
        }
        arrow.addEventListener('click', function() { selectComponent(message.id); });
        arrow.addEventListener('contextmenu', function(e) { showContextMenu(e, message.id); });
      }
      return arrow;
    }

    // ========== Enhanced Workflow (V2) ==========

    function computeWorkflowLayout(workflow) {
      if (!workflow || !workflow.nodes || !workflow.edges) {
        return { layers: [], nodePositions: new Map(), edgeRoutes: [], nodeMap: new Map() };
      }

      var adjList = new Map();
      var inDegree = new Map();
      var nodeMap = new Map();

      workflow.nodes.forEach(function(node) {
        nodeMap.set(node.id, node);
        adjList.set(node.id, []);
        inDegree.set(node.id, 0);
      });

      workflow.edges.forEach(function(edge) {
        if (!adjList.has(edge.from) || !adjList.has(edge.to)) return;
        // Skip loop edges for layer calculation
        if (edge.type === 'loop') return;
        adjList.get(edge.from).push(edge);
        inDegree.set(edge.to, inDegree.get(edge.to) + 1);
      });

      // Topological sort with longest path layer assignment
      var nodeLayer = new Map();
      var queue = [];

      // Find start nodes
      workflow.nodes.forEach(function(node) {
        if (inDegree.get(node.id) === 0 || node.type === 'start') {
          queue.push({ id: node.id, layer: 0 });
          nodeLayer.set(node.id, 0);
        }
      });

      // Handle disconnected nodes (fallback)
      if (queue.length === 0 && workflow.nodes.length > 0) {
        queue.push({ id: workflow.nodes[0].id, layer: 0 });
        nodeLayer.set(workflow.nodes[0].id, 0);
      }

      // Prevent infinite loops with malformed configs
      var maxIterations = workflow.nodes.length * workflow.edges.length + workflow.nodes.length;
      var iterations = 0;

      while (queue.length > 0) {
        if (++iterations > maxIterations) {
          console.error('Workflow layout: exceeded max iterations, possible circular dependency');
          break;
        }
        var current = queue.shift();
        var edges = adjList.get(current.id) || [];
        edges.forEach(function(edge) {
          var childId = edge.to;
          var childLayer = current.layer + 1;
          if (!nodeLayer.has(childId) || nodeLayer.get(childId) < childLayer) {
            nodeLayer.set(childId, childLayer);
            queue.push({ id: childId, layer: childLayer });
          }
        });
      }

      // Handle any remaining unvisited nodes
      workflow.nodes.forEach(function(node) {
        if (!nodeLayer.has(node.id)) {
          nodeLayer.set(node.id, 0);
        }
      });

      // Build layers array
      var maxLayer = 0;
      nodeLayer.forEach(function(layer) { maxLayer = Math.max(maxLayer, layer); });

      var layers = [];
      for (var i = 0; i <= maxLayer; i++) layers.push([]);

      nodeLayer.forEach(function(layer, nodeId) {
        layers[layer].push(nodeId);
      });

      // Compute node positions
      var nodePositions = new Map();
      layers.forEach(function(layer, layerIndex) {
        layer.forEach(function(nodeId, posIndex) {
          nodePositions.set(nodeId, {
            layer: layerIndex,
            position: posIndex,
            total: layer.length
          });
        });
      });

      // Compute edge routes (including loops)
      var edgeRoutes = workflow.edges.map(function(edge) {
        var fromPos = nodePositions.get(edge.from);
        var toPos = nodePositions.get(edge.to);
        if (!fromPos || !toPos) {
          console.warn('Workflow edge skipped: node not found', {
            edge: edge,
            fromExists: !!fromPos,
            toExists: !!toPos
          });
          return null;
        }

        return {
          id: edge.id,
          from: edge.from,
          to: edge.to,
          fromPos: fromPos,
          toPos: toPos,
          label: edge.label,
          type: edge.type === 'loop' || toPos.layer <= fromPos.layer ? 'loop' : 'straight',
          branch: edge.branch || null
        };
      }).filter(Boolean);

      return { layers: layers, nodePositions: nodePositions, edgeRoutes: edgeRoutes, nodeMap: nodeMap };
    }

    function createArrowMarker(id, color) {
      var marker = document.createElementNS('http://www.w3.org/2000/svg', 'marker');
      marker.setAttribute('id', id);
      marker.setAttribute('markerWidth', '10');
      marker.setAttribute('markerHeight', '10');
      marker.setAttribute('refX', '9');
      marker.setAttribute('refY', '3');
      marker.setAttribute('orient', 'auto');
      var polygon = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
      polygon.setAttribute('points', '0 0, 10 3, 0 6');
      polygon.setAttribute('fill', color);
      marker.appendChild(polygon);
      return marker;
    }

    function renderEnhancedWorkflow() {
      var canvas = document.getElementById('diagram-canvas');
      canvas.textContent = '';

      var workflow = CONFIG.workflowStructureV2;
      if (!workflow || !workflow.nodes || workflow.nodes.length === 0) {
        renderWorkflowView();
        return;
      }

      var layout = computeWorkflowLayout(workflow);
      if (layout.layers.length === 0) {
        var placeholder = document.createElement('div');
        placeholder.style.cssText = 'color: #8b949e; padding: 40px; text-align: center;';
        placeholder.textContent = 'No workflow nodes found';
        canvas.appendChild(placeholder);
        return;
      }

      var diagram = document.createElement('div');
      diagram.className = 'workflow-diagram-v2';

      var svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      svg.setAttribute('class', 'workflow-edges');
      var defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
      defs.appendChild(createArrowMarker('workflow-arrow', '#58a6ff'));
      defs.appendChild(createArrowMarker('workflow-arrow-loop', '#a371f7'));
      defs.appendChild(createArrowMarker('workflow-arrow-secondary', '#8b949e'));
      svg.appendChild(defs);
      diagram.appendChild(svg);

      var nodeElements = new Map();

      layout.layers.forEach(function(layerNodes, layerIndex) {
        var layerDiv = document.createElement('div');
        layerDiv.className = 'workflow-layer';
        layerDiv.dataset.layer = layerIndex;

        layerNodes.forEach(function(nodeId) {
          var node = layout.nodeMap.get(nodeId);
          var nodeEl = createWorkflowNode(node);
          nodeElements.set(nodeId, nodeEl);
          layerDiv.appendChild(nodeEl);
        });

        diagram.appendChild(layerDiv);
      });

      canvas.appendChild(diagram);

      // Render edges after DOM layout
      setTimeout(function() {
        var diagramRect = diagram.getBoundingClientRect();
        // Set explicit SVG dimensions to ensure proper rendering
        svg.setAttribute('width', diagramRect.width);
        svg.setAttribute('height', diagramRect.height);

        var svgRect = diagram.getBoundingClientRect();
        layout.edgeRoutes.forEach(function(route) {
          var fromEl = nodeElements.get(route.from);
          var toEl = nodeElements.get(route.to);
          if (fromEl && toEl) {
            var edge = createWorkflowEdge(route, fromEl, toEl, svgRect);
            if (edge) svg.appendChild(edge);
          }
        });
      }, 50);
    }

    function createWorkflowNode(node) {
      var wrapper = document.createElement('div');
      var nodeType = node.type || 'process';
      wrapper.className = 'workflow-node workflow-node-' + nodeType;
      if (node.phase) wrapper.classList.add(node.phase);

      var componentId = node.componentId || node.id;
      wrapper.dataset.component = componentId;

      if (state.selectedComponent === componentId) {
        wrapper.classList.add('selected');
      }
      if (state.annotations[componentId] && state.annotations[componentId].length > 0) {
        wrapper.classList.add('has-annotation');
        wrapper.dataset.annotationCount = state.annotations[componentId].length;
      }

      wrapper.addEventListener('click', function() { selectComponent(componentId); });
      wrapper.addEventListener('contextmenu', function(e) { showContextMenu(e, componentId); });

      if (nodeType === 'decision') {
        var content = document.createElement('div');
        content.className = 'decision-content';
        content.textContent = node.label || '?';
        wrapper.appendChild(content);
      } else if (nodeType === 'merge') {
        wrapper.textContent = '\u2295';
      } else if (nodeType === 'start' || nodeType === 'end') {
        wrapper.textContent = node.label || (nodeType === 'start' ? 'Start' : 'End');
      } else {
        var title = document.createElement('div');
        title.className = 'workflow-node-title';
        title.textContent = node.label || 'Process';
        wrapper.appendChild(title);

        if (state.componentData[componentId]) {
          var subtitle = document.createElement('div');
          subtitle.className = 'workflow-node-subtitle';
          subtitle.textContent = state.componentData[componentId].badgeLabel || '';
          wrapper.appendChild(subtitle);
        }
      }

      return wrapper;
    }

    function createWorkflowEdge(route, fromEl, toEl, svgRect) {
      var fromRect = fromEl.getBoundingClientRect();
      var toRect = toEl.getBoundingClientRect();

      var fromX = fromRect.left + fromRect.width / 2 - svgRect.left;
      var fromY = fromRect.bottom - svgRect.top;
      var toX = toRect.left + toRect.width / 2 - svgRect.left;
      var toY = toRect.top - svgRect.top;

      var path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      path.setAttribute('class', 'workflow-edge');

      var d;
      if (route.type === 'loop') {
        // Curved loop-back path on the right side
        var controlOffset = 100;
        var controlX = Math.max(fromX, toX) + controlOffset;
        d = 'M ' + fromX + ' ' + fromY + ' C ' + controlX + ' ' + fromY + ', ' + controlX + ' ' + toY + ', ' + toX + ' ' + toY;
        path.classList.add('loop');
        path.setAttribute('marker-end', 'url(#workflow-arrow-loop)');
      } else {
        // Straight or angled path
        if (Math.abs(fromX - toX) < 10) {
          d = 'M ' + fromX + ' ' + fromY + ' L ' + toX + ' ' + toY;
        } else {
          var midY = (fromY + toY) / 2;
          d = 'M ' + fromX + ' ' + fromY + ' L ' + fromX + ' ' + midY + ' L ' + toX + ' ' + midY + ' L ' + toX + ' ' + toY;
        }

        if (route.branch === 'secondary') {
          path.classList.add('secondary');
          path.setAttribute('marker-end', 'url(#workflow-arrow-secondary)');
        } else {
          path.setAttribute('marker-end', 'url(#workflow-arrow)');
        }
      }

      path.setAttribute('d', d);

      if (route.id) {
        path.dataset.edgeId = route.id;
      }

      return path;
    }

    // ========== End Enhanced Workflow ==========

    function renderCurrentView() {
      if (state.currentView === 'workflow') {
        if (CONFIG.workflowStructureV2) {
          renderEnhancedWorkflow();
        } else {
          renderWorkflowView();
        }
      }
      else if (state.currentView === 'dataflow') renderDataFlowView();
      else if (state.currentView === 'files') renderFilesView();
      else if (state.currentView === 'sequence') renderSequenceView();
    }

    function createNodeBox(id, phaseClass) {
      var data = state.componentData[id] || { title: id, badgeLabel: '' };
      var box = document.createElement('div');
      box.className = 'node-box ' + phaseClass;
      if (state.selectedComponent === id) box.classList.add('selected');
      if (state.annotations[id] && state.annotations[id].length > 0) {
        box.classList.add('has-annotation');
        var badge = document.createElement('div');
        badge.className = 'annotation-badge';
        badge.textContent = state.annotations[id].length;
        box.appendChild(badge);
      }
      box.dataset.component = id;
      var title = document.createElement('div');
      title.className = 'node-title';
      title.textContent = data.title.split(' (')[0];
      box.appendChild(title);
      var subtitle = document.createElement('div');
      subtitle.className = 'node-subtitle';
      subtitle.textContent = data.badgeLabel || '';
      box.appendChild(subtitle);
      box.addEventListener('click', function() { selectComponent(id); });
      box.addEventListener('contextmenu', function(e) { showContextMenu(e, id); });
      return box;
    }

    function selectComponent(id) {
      state.selectedComponent = id;
      updateDetails();
      renderCurrentView();
      renderTree();
    }

    function renderEmptyState() {
      var detailContent = document.getElementById('detail-content');
      detailContent.textContent = '';
      var section = document.createElement('div');
      section.className = 'detail-section';
      var title = document.createElement('div');
      title.className = 'detail-section-title';
      title.textContent = 'Getting Started';
      section.appendChild(title);
      var text = document.createElement('p');
      text.className = 'detail-text';
      text.textContent = 'Click on any component in the tree or diagram to see details. Right-click to add annotations.';
      section.appendChild(text);
      detailContent.appendChild(section);
    }

    function updateDetails() {
      var id = state.selectedComponent;
      var data = state.componentData[id];
      var detailContent = document.getElementById('detail-content');
      var detailTitle = document.getElementById('detail-title');
      var detailBadge = document.getElementById('detail-badge');

      // Check if we have annotations for this component even without componentData
      var annotations = state.annotations[id] || [];

      if (!data && annotations.length === 0) {
        detailTitle.textContent = 'Select a component';
        detailBadge.style.display = 'none';
        renderEmptyState();
        return;
      }

      // Show title from componentData or use the ID
      detailTitle.textContent = data ? data.title : id;
      if (data) {
        detailBadge.textContent = data.badgeLabel;
        detailBadge.className = 'details-badge badge-' + data.badge;
        detailBadge.style.display = 'inline';
      } else {
        detailBadge.style.display = 'none';
      }
      detailContent.textContent = '';

      if (annotations.length > 0) {
        var annoSection = document.createElement('div');
        annoSection.className = 'annotations-section';
        var annoTitle = document.createElement('div');
        annoTitle.className = 'detail-section-title';
        annoTitle.textContent = 'Your Annotations (' + annotations.length + ')';
        annoSection.appendChild(annoTitle);
        annotations.forEach(function(a, idx) {
          var item = document.createElement('div');
          item.className = 'annotation-item';
          var header = document.createElement('div');
          header.className = 'annotation-header';
          var type = document.createElement('span');
          type.className = 'annotation-type ' + a.type;
          type.textContent = a.type;
          header.appendChild(type);
          var deleteBtn = document.createElement('button');
          deleteBtn.className = 'annotation-delete';
          deleteBtn.textContent = 'x';
          deleteBtn.addEventListener('click', function() {
            state.annotations[id].splice(idx, 1);
            if (state.annotations[id].length === 0) delete state.annotations[id];
            saveState(); updateAnnotationsSummary(); renderCurrentView(); renderTree(); updateDetails();
          });
          header.appendChild(deleteBtn);
          item.appendChild(header);
          var text = document.createElement('div');
          text.className = 'annotation-text';
          text.textContent = a.text;
          item.appendChild(text);
          if (a.prompt) {
            var promptHeader = document.createElement('div');
            promptHeader.className = 'annotation-prompt-header';
            var promptLabel = document.createElement('span');
            promptLabel.className = 'annotation-prompt-label';
            promptLabel.textContent = 'Prompt for Claude';
            promptHeader.appendChild(promptLabel);
            var copyBtn = document.createElement('button');
            copyBtn.className = 'annotation-copy-btn';
            copyBtn.textContent = 'Copy';
            copyBtn.addEventListener('click', function() {
              navigator.clipboard.writeText(a.prompt).then(function() {
                copyBtn.textContent = 'Copied!';
                copyBtn.classList.add('copied');
                setTimeout(function() { copyBtn.textContent = 'Copy'; copyBtn.classList.remove('copied'); }, 1500);
              });
            });
            promptHeader.appendChild(copyBtn);
            item.appendChild(promptHeader);
            var promptDiv = document.createElement('div');
            promptDiv.className = 'annotation-prompt';
            promptDiv.textContent = a.prompt;
            item.appendChild(promptDiv);
          }
          annoSection.appendChild(item);
        });
        var addBtn = document.createElement('button');
        addBtn.className = 'add-annotation-btn';
        addBtn.textContent = '+ Add another annotation';
        addBtn.addEventListener('click', function() { openAnnotationModal(id); });
        annoSection.appendChild(addBtn);
        detailContent.appendChild(annoSection);
      }

      // Only show component details if we have componentData
      if (data) {
        if (data.file) {
          var fileDiv = document.createElement('div');
          fileDiv.className = 'detail-file';
          fileDiv.textContent = data.file;
          detailContent.appendChild(fileDiv);
        }

        var descSection = document.createElement('div');
        descSection.className = 'detail-section';
        var descTitle = document.createElement('div');
        descTitle.className = 'detail-section-title';
        descTitle.textContent = 'Description';
        descSection.appendChild(descTitle);
        var descText = document.createElement('p');
        descText.className = 'detail-text';
        descText.textContent = data.description;
        descSection.appendChild(descText);
        detailContent.appendChild(descSection);

        if (data.responsibilities) {
          var respSection = document.createElement('div');
          respSection.className = 'detail-section';
          var respTitle = document.createElement('div');
          respTitle.className = 'detail-section-title';
          respTitle.textContent = 'Responsibilities';
          respSection.appendChild(respTitle);
          var respList = document.createElement('ul');
          respList.className = 'detail-list';
          data.responsibilities.forEach(function(r) {
            var li = document.createElement('li');
            li.textContent = r;
            respList.appendChild(li);
          });
          respSection.appendChild(respList);
          detailContent.appendChild(respSection);
        }

        if (data.code) {
          var codeSection = document.createElement('div');
          codeSection.className = 'detail-section';
          var codeTitle = document.createElement('div');
          codeTitle.className = 'detail-section-title';
          codeTitle.textContent = 'Interface / Code';
          codeSection.appendChild(codeTitle);
          var codePre = document.createElement('pre');
          codePre.className = 'detail-code';
          codePre.textContent = data.code;
          codeSection.appendChild(codePre);
          detailContent.appendChild(codeSection);
        }
      }

      if (annotations.length === 0) {
        var actSection = document.createElement('div');
        actSection.className = 'detail-section';
        var actTitle = document.createElement('div');
        actTitle.className = 'detail-section-title';
        actTitle.textContent = 'Annotate';
        actSection.appendChild(actTitle);
        var addBtn = document.createElement('button');
        addBtn.className = 'add-annotation-btn';
        addBtn.textContent = '+ Add annotation (or right-click)';
        addBtn.addEventListener('click', function() { openAnnotationModal(id); });
        actSection.appendChild(addBtn);
        detailContent.appendChild(actSection);
      }
    }

    function showContextMenu(e, componentId) {
      e.preventDefault();
      state.contextTarget = componentId;
      var menu = document.getElementById('context-menu');
      menu.style.left = e.pageX + 'px';
      menu.style.top = e.pageY + 'px';
      menu.classList.add('visible');
    }

    function hideContextMenu() { document.getElementById('context-menu').classList.remove('visible'); }
    document.addEventListener('click', hideContextMenu);

    document.querySelectorAll('.context-menu-item').forEach(function(item) {
      item.addEventListener('click', function() {
        var action = item.dataset.action;
        if (action === 'view') selectComponent(state.contextTarget);
        else openAnnotationModal(state.contextTarget, action);
        hideContextMenu();
      });
    });

    function openAnnotationModal(componentId, type) {
      state.contextTarget = componentId;
      var data = state.componentData[componentId] || { title: componentId };
      document.getElementById('modal-title').textContent = 'Annotate: ' + data.title;
      document.getElementById('annotation-type').value = type || 'question';
      document.getElementById('annotation-text').value = '';
      document.getElementById('modal-overlay').classList.add('visible');
      document.getElementById('annotation-text').focus();
    }

    document.getElementById('modal-cancel').addEventListener('click', function() {
      document.getElementById('modal-overlay').classList.remove('visible');
    });

    document.getElementById('modal-save').addEventListener('click', function() {
      var type = document.getElementById('annotation-type').value;
      var text = document.getElementById('annotation-text').value.trim();
      if (text) {
        var prompt = generatePromptForAnnotation(state.contextTarget, type, text);
        if (!state.annotations[state.contextTarget]) state.annotations[state.contextTarget] = [];
        state.annotations[state.contextTarget].push({ type: type, text: text, prompt: prompt, timestamp: Date.now() });
        saveState(); updateAnnotationsSummary(); renderCurrentView(); renderTree(); selectComponent(state.contextTarget);
      }
      document.getElementById('modal-overlay').classList.remove('visible');
    });

    function generatePromptForAnnotation(componentId, type, text) {
      var data = state.componentData[componentId] || { title: componentId, file: '' };
      var prompt = 'In the ' + PROJECT_NAME + ' codebase';
      if (type === 'question') {
        prompt = text + '\n\nContext: This question is about the ' + data.title + ' component';
        if (data.file) prompt += ' in ' + data.file;
        prompt += '.';
      } else if (type === 'comment') {
        prompt = 'I have an observation about ' + data.title + ': ' + text;
        prompt += '\n\nCan you provide more context or confirm this understanding?';
        if (data.file) prompt += '\n\nFile: ' + data.file;
      } else if (type === 'edit') {
        prompt = 'I want to make an edit to ' + data.title + ': ' + text;
        prompt += '\n\nCan you help me implement this change?';
        if (data.file) prompt += '\n\nFile: ' + data.file;
      }
      return prompt;
    }

    document.getElementById('modal-overlay').addEventListener('click', function(e) {
      if (e.target === this) this.classList.remove('visible');
    });

    document.getElementById('ask-btn').addEventListener('click', function() {
      var q = document.getElementById('question-input').value.trim();
      if (q) {
        var comp = state.selectedComponent;
        var prompt = q;
        if (comp && state.componentData[comp]) {
          var data = state.componentData[comp];
          prompt += '\n\nContext: Looking at ' + data.title;
          if (data.file) prompt += ' (' + data.file + ')';
          prompt += ' in the ' + PROJECT_NAME + ' codebase.';
        } else {
          prompt += '\n\nContext: ' + PROJECT_NAME + ' codebase.';
        }
        var targetId = comp || 'general';
        if (!state.annotations[targetId]) state.annotations[targetId] = [];
        state.annotations[targetId].push({ type: 'question', text: q, prompt: prompt, timestamp: Date.now() });
        saveState(); updateAnnotationsSummary();
        if (comp) selectComponent(comp);
        else updateDetails();
        document.getElementById('question-input').value = '';
      }
    });

    document.getElementById('question-input').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') document.getElementById('ask-btn').click();
    });

    document.querySelectorAll('.view-tab').forEach(function(tab) {
      tab.addEventListener('click', function() {
        state.currentView = tab.dataset.view;
        document.querySelectorAll('.view-tab').forEach(function(t) { t.classList.remove('active'); });
        tab.classList.add('active');
        renderCurrentView();
      });
    });

    document.getElementById('export-btn').addEventListener('click', function() {
      var output = 'Architecture Annotations - ' + PROJECT_NAME + '\n' + '='.repeat(50) + '\n\n';
      Object.keys(state.annotations).forEach(function(key) {
        var data = state.componentData[key] || { title: key };
        output += '## ' + data.title + '\n';
        state.annotations[key].forEach(function(a) { output += '- [' + a.type.toUpperCase() + '] ' + a.text + '\n'; });
        output += '\n';
      });
      navigator.clipboard.writeText(output).then(function() { alert('Annotations exported to clipboard!'); });
    });

    document.getElementById('reset-btn').addEventListener('click', clearState);
    document.getElementById('clear-btn').addEventListener('click', function() {
      if (confirm('Clear all annotations?')) {
        state.annotations = {};
        saveState(); updateAnnotationsSummary(); renderCurrentView(); renderTree(); updateDetails();
      }
    });

    var wasLoaded = loadState();

    // Set header title from config
    document.getElementById('header-title').textContent = PROJECT_NAME + ' - Architecture Explorer';
    document.title = PROJECT_NAME + ' - Architecture Explorer';

    renderTree();
    renderCurrentView();
    updateAnnotationsSummary();
    updateDetails();
    if (wasLoaded) console.log('Restored saved state from localStorage');
    })(); // End init
  </script>
</body>
</html>
